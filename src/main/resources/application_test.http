### =============================================
### TESTS COMPLETS CORRIGÃ‰S - APPLICATION ALLTOGETHER
### =============================================
### Variables globales
@baseUrl = http://localhost:8080



### =============================================
### 1. TESTS DES ENDPOINTS PUBLICS
### =============================================

### 1.1 API racine (peut retourner 404 - c'est normal)
GET {{baseUrl}}/

> {%
    client.test("API racine", function() {
        client.log("Statut racine: " + response.status + " (404 est normal)");
    });
%}

### 1.2 Liste des villes (public)
GET {{baseUrl}}/api/cities

> {%
    client.test("Liste villes publique", function() {
        client.assert(response.status === 200, "Villes doivent Ãªtre publiques");
        client.assert(Array.isArray(response.body), "Doit retourner un tableau");
    });
%}

### =============================================
### 2. INSCRIPTION ET AUTHENTIFICATION
### =============================================

### 2.1 Inscription utilisateur valide
# @name registerUser
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "firstName": "Jean",
  "lastName": "Dupont",
  "email": "jean.dupont@test.com",
  "password": "Password123",
  "age": 28,
  "currentCity": "Lyon",
  "countryOrigin": "France"
}

> {%
    client.test("Inscription valide", function() {
        if (response.status === 200) {
            client.log("âœ… Inscription rÃ©ussie");
        } else if (response.status === 400) {
            client.log("â„¹ï¸ Utilisateur existe dÃ©jÃ  - continuation");
        } else {
            client.log("âŒ Erreur: " + response.status);
        }
    });
%}

### 2.2 Connexion rÃ©ussie - USER
# @name loginUser
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "jean.dupont@test.com",
  "password": "Password123"
}

> {%
    client.test("Connexion USER", function() {
        client.assert(response.status === 200, "Connexion USER devrait rÃ©ussir");
        if (response.status === 200) {
            const userToken = response.body.token;
            client.global.set("userToken", userToken);
            client.log("âœ… Token USER: " + userToken.substring(0, 50) + "...");
        }
    });
%}

### 2.3 CrÃ©ation et connexion ADMIN
# @name createAdmin
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "firstName": "Admin",
  "lastName": "System",
  "email": "admin.system@test.com",
  "password": "Admin123",
  "age": 35,
  "currentCity": "Paris",
  "countryOrigin": "France"
}

> {%
    client.test("CrÃ©ation ADMIN", function() {
        client.log("Statut crÃ©ation ADMIN: " + response.status);
    });
%}

### 2.4 Connexion ADMIN
# @name loginAdmin
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "admin.system@test.com",
  "password": "Admin123"
}

> {%
    client.test("Connexion ADMIN", function() {
        client.assert(response.status === 200, "Connexion ADMIN devrait rÃ©ussir");
        if (response.status === 200) {
            const adminToken = response.body.token;
            client.global.set("adminToken", adminToken);
            client.log("âœ… Token ADMIN: " + adminToken.substring(0, 50) + "...");
        }
    });
%}

### =============================================
### 3. TESTS AVEC TOKENS EXPLICITES
### =============================================

### 3.1 User peut lire les lieux (avec token EXPLICITE)
GET {{baseUrl}}/api/places
Authorization: Bearer {{userToken}}

> {%
    client.test("USER - Lecture lieux", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: User peut lire les lieux");
        } else {
            client.log("âŒ Ã‰CHEC: User ne peut pas lire les lieux - " + response.status);
        }
    });
%}

### 3.2 User ne peut pas crÃ©er de lieux
POST {{baseUrl}}/api/places
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "name": "Lieu User Tentative",
  "category": "MONUMENT_HISTORIQUE",
  "address": "User essaie de crÃ©er",
  "cityId": 1
}

> {%
    client.test("USER - CrÃ©ation lieux bloquÃ©e", function() {
        if (response.status === 403) {
            client.log("âœ… SUCCÃˆS: User correctement bloquÃ© pour crÃ©er lieux");
        } else {
            client.log("âŒ ATTENTION: Statut inattendu: " + response.status);
        }
    });
%}

### 3.3 User ne peut pas accÃ©der aux utilisateurs
GET {{baseUrl}}/api/users
Authorization: Bearer {{userToken}}

> {%
    client.test("USER - AccÃ¨s utilisateurs bloquÃ©", function() {
        if (response.status === 403) {
            client.log("âœ… SUCCÃˆS: User correctement bloquÃ© pour /api/users");
        } else {
            client.log("âŒ ATTENTION: Statut inattendu: " + response.status);
        }
    });
%}

### 3.4 Admin peut accÃ©der aux utilisateurs
GET {{baseUrl}}/api/users
Authorization: Bearer {{adminToken}}

> {%
    client.test("ADMIN - AccÃ¨s utilisateurs", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Admin peut accÃ©der aux users");
            // Sauvegarder un ID utilisateur
            if (response.body && response.body.length > 0) {
                client.global.set("userId", response.body[0].id);
                client.log("âœ… User ID sauvegardÃ©: " + client.global.get("userId"));
            }
        } else {
            client.log("âŒ Ã‰CHEC: Admin ne peut pas accÃ©der aux users - " + response.status);
        }
    });
%}
### 3.5 Admin peut crÃ©er un lieu (TEST CORRIGÃ‰)
# @name createPlace
POST {{baseUrl}}/api/places
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "name": "Bar Test Final",
  "category": "BAR",
  "address": "123 Rue Finale, Paris",
  "description": "Test de crÃ©ation avec DTO corrigÃ©",
  "cityId": 1
}

> {%
    client.test("ADMIN - CrÃ©ation lieu corrigÃ©", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Admin peut crÃ©er des lieux");
            client.global.set("placeId", response.body.id);
            client.log("âœ… Place ID sauvegardÃ©: " + client.global.get("placeId"));
        } else {
            client.log("âŒ Ã‰CHEC: " + response.status);
            client.log("Erreur: " + JSON.stringify(response.body));
        }
    });
%}


### =============================================
### 4. GESTION DES PARTICIPATIONS
### =============================================

GET {{baseUrl}}/api/places/276
Authorization: Bearer {{adminToken}}

> {%
    if (response.status === 200) {
        client.log("âœ… Lieu 276: " + response.body.name);
        client.global.set("placeId", "276");
    }
%}

### 4.1 User peut crÃ©er une participation (AVEC LOGGING)
# @name createParticipation
POST {{baseUrl}}/api/participations?userId=10&placeId=276&status=INSCRIT
Authorization: Bearer {{userToken}}

> {%
    client.test("USER - CrÃ©ation participation avec logging", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: User peut crÃ©er participation");
            client.global.set("participationId", response.body.id);
            client.log("âœ… Participation ID: " + client.global.get("participationId"));
        } else {
            client.log("âŒ Ã‰CHEC: " + response.status + " - " + response.body);
            client.log("âš ï¸ Regardez les logs Spring Boot pour le diagnostic");
        }
    });
%}
### 4.2 VÃ©rifier la prÃ©vention des doublons
POST {{baseUrl}}/api/participations?userId={{userId}}&placeId={{placeId}}&status=INSCRIT
Authorization: Bearer {{userToken}}

> {%
    client.test("PrÃ©vention doublons", function() {
        if (response.status === 400) {
            client.log("âœ… SUCCÃˆS: Doublon bloquÃ© avec 400");
        } else if (response.status === 200) {
            client.log("âš ï¸ ATTENTION: Doublon crÃ©Ã© (vÃ©rification non implÃ©mentÃ©e)");
        } else {
            client.log("Statut: " + response.status);
        }
    });
%}

### 4.3 Participation Ã  date diffÃ©rente
POST {{baseUrl}}/api/participations?userId={{userId}}&placeId={{placeId}}&status=INSCRIT&participationDate=2024-01-16
Authorization: Bearer {{userToken}}

> {%
    client.test("Participation date diffÃ©rente", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Participation date diffÃ©rente autorisÃ©e");
        } else {
            client.log("âŒ Ã‰CHEC: " + response.status);
        }
    });
%}

### 4.4 Lister les participations d'un utilisateur
GET {{baseUrl}}/api/participations/user/{{userId}}
Authorization: Bearer {{userToken}}

> {%
    client.test("Liste participations par user", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Liste participations retournÃ©e");
            client.assert(Array.isArray(response.body), "Doit retourner un tableau");
        } else {
            client.log("âŒ Ã‰CHEC: " + response.status);
        }
    });
%}

### =============================================
### 5. TESTS DE SÃ‰CURITÃ‰
### =============================================

### 5.1 AccÃ¨s sans token
GET {{baseUrl}}/api/users

> {%
    client.test("SÃ©curitÃ© - AccÃ¨s sans token", function() {
        if (response.status === 401 || response.status === 403) {
            client.log("âœ… SUCCÃˆS: AccÃ¨s sans token bloquÃ©");
        } else {
            client.log("âŒ Ã‰CHEC: AccÃ¨s sans token autorisÃ© - " + response.status);
        }
    });
%}

### 5.2 Token invalide
GET {{baseUrl}}/api/users
Authorization: Bearer token.invalide.fake.12345

> {%
    client.test("SÃ©curitÃ© - Token invalide", function() {
        if (response.status === 401 || response.status === 403) {
            client.log("âœ… SUCCÃˆS: Token invalide bloquÃ©");
        } else {
            client.log("âŒ Ã‰CHEC: Token invalide acceptÃ© - " + response.status);
        }
    });
%}

### =============================================
### 6. DIAGNOSTIC FINAL
### =============================================

### 6.1 VÃ©rification des tokens
GET {{baseUrl}}/api/cities

> {%
    client.test("Diagnostic final", function() {
        client.log(" ");
        client.log("=== ðŸ” DIAGNOSTIC DES VARIABLES ===");
        client.log("userToken dÃ©fini: " + (client.global.get("userToken") ? "âœ… OUI" : "âŒ NON"));
        client.log("adminToken dÃ©fini: " + (client.global.get("adminToken") ? "âœ… OUI" : "âŒ NON"));
        client.log("userId: " + (client.global.get("userId") || "âŒ Non dÃ©fini"));
        client.log("placeId: " + (client.global.get("placeId") || "âŒ Non dÃ©fini"));
        client.log("participationId: " + (client.global.get("participationId") || "âŒ Non dÃ©fini"));
        if (!client.global.get("userToken") || !client.global.get("adminToken")) {
            client.log(" ");
            client.log("ðŸš¨ PROBLÃˆME: Les tokens ne sont pas sauvegardÃ©s!");
            client.log("Solution: Utilisez les tokens manuellement:");
            client.log("User Token: " + (client.global.get("userToken") || "NON DÃ‰FINI"));
            client.log("Admin Token: " + (client.global.get("adminToken") || "NON DÃ‰FINI"));
        }
    });
%}

### =============================================
### 7. TESTS MANUELS (si les variables ne fonctionnent pas)
### =============================================

### 7.1 Test manuel USER - Remplacez TOKEN_USER par le vrai token
GET {{baseUrl}}/api/places
Authorization: Bearer TOKEN_USER

> {%
    client.test("Test manuel USER", function() {
        client.log("Test manuel USER: " + response.status);
    });
%}

### 7.2 Test manuel ADMIN - Remplacez TOKEN_ADMIN par le vrai token
GET {{baseUrl}}/api/users
Authorization: Bearer TOKEN_ADMIN

> {%
    client.test("Test manuel ADMIN", function() {
        client.log("Test manuel ADMIN: " + response.status);
    });
%}

### 7.3 Admin peut mettre Ã  jour un utilisateur (TEST CORRIGÃ‰)
PUT {{baseUrl}}/api/users/{{userId}}
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "firstName": "Jean-ModifiÃ©",
  "lastName": "Dupont-ModifiÃ©",
  "email": "jean.unique456@test.com",
  "age": 29,
  "currentCity": "Marseille"
}

> {%
    client.test("Admin - Mise Ã  jour utilisateur corrigÃ©", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Admin peut modifier des users");
            client.assert(response.status === 200, "Admin doit pouvoir modifier des users");
        } else {
            client.log("âŒ Ã‰CHEC: " + response.status);
        }
    });
%}
### 7.4 Admin peut changer le mot de passe (CORRIGÃ‰)
PUT {{baseUrl}}/api/users/{{userId}}/password
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "currentPassword": "Admin123",
  "newPassword": "NewPassword123"
}

> {%
    client.test("Admin - Changement mot de passe", function() {
        if (response.status === 200 || response.status === 204) {
            client.log("âœ… SUCCÃˆS: Admin peut changer les mots de passe");
        } else {
            client.log("âš ï¸ Statut: " + response.status);
        }
    });
%}
### =============================================
### 8. TESTS DE SÃ‰CURITÃ‰ AVANCÃ‰S
### =============================================

### 8.1 AccÃ¨s sans token
GET {{baseUrl}}/api/users

> {%
    client.test("SÃ©curitÃ© - AccÃ¨s sans token", function() {
        client.assert(response.status === 401 || response.status === 403,
            "Doit bloquer sans authentification");
    });
%}

### 8.2 Token invalide
GET {{baseUrl}}/api/users
Authorization: Bearer token.invalide.fake.12345

> {%
    client.test("SÃ©curitÃ© - Token invalide", function() {
        client.assert(response.status === 401 || response.status === 403,
            "Doit bloquer token invalide");
    });
%}

### 8.3 User tente d'accÃ©der aux endpoints admin
POST {{baseUrl}}/api/users
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "firstName": "Tentative",
  "lastName": "Usurpation",
  "email": "usurpation@test.com",
  "password": "password123",
  "age": 25,
  "currentCity": "Test"
}

> {%
    client.test("SÃ©curitÃ© - User tente crÃ©ation user", function() {
        client.assert(response.status === 403, "Doit bloquer user qui tente crÃ©ation admin");
    });
%}


### =============================================
### 9. TESTS DES FONCTIONNALITÃ‰S SPÃ‰CIFIQUES
### =============================================

### 9.1 Lieux par catÃ©gorie (NOUVELLE STRUCTURE)
GET {{baseUrl}}/api/places?category=BAR
Authorization: Bearer {{userToken}}

> {%
    client.test("Lieux par catÃ©gorie BAR", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Recherche par catÃ©gorie fonctionne");
            client.log("ðŸ“Š Nombre de lieux BAR: " + response.body.length);
        } else {
            client.log("âŒ Ã‰CHEC: " + response.status);
        }
    });
%}

### Test recherche par ville
GET {{baseUrl}}/api/places?city=Paris
Authorization: Bearer {{userToken}}

> {%
    client.test("Lieux par ville Paris", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Recherche par ville fonctionne");
        }
    });
%}

### Test recherche combinÃ©e
GET {{baseUrl}}/api/places?category=BAR&city=Paris
Authorization: Bearer {{userToken}}

> {%
    client.test("Lieux BAR Ã  Paris", function() {
        if (response.status === 200) {
            client.log("âœ… SUCCÃˆS: Recherche combinÃ©e fonctionne");
        }
    });
%}
### 9.2 Lieux par ville
GET {{baseUrl}}/api/places/city/1
Authorization: Bearer {{userToken}}

> {%
    client.test("Lieux par ville", function() {
        client.assert(response.status === 200, "Doit retourner lieux par ville");
    });
%}

### 9.3 RÃ©cupÃ©ration lieu spÃ©cifique
GET {{baseUrl}}/api/places/{{placeId}}
Authorization: Bearer {{userToken}}

> {%
    client.test("RÃ©cupÃ©ration lieu spÃ©cifique", function() {
        client.assert(response.status === 200, "Doit retourner le lieu spÃ©cifique");
    });
%}

### 9.4 RÃ©cupÃ©ration participation spÃ©cifique
GET {{baseUrl}}/api/participations/{{participationId}}
Authorization: Bearer {{userToken}}

> {%
    client.test("RÃ©cupÃ©ration participation spÃ©cifique", function() {
        client.assert(response.status === 200, "Doit retourner la participation");
    });
%}

### =============================================
### 10. TESTS DE PERFORMANCE ET RÃ‰SILIENCE
### =============================================

### 10.1 DonnÃ©es manquantes dans le body
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

{
  "firstName": "Test"
}

> {%
    client.test("RÃ©silience - DonnÃ©es manquantes", function() {
        client.assert(response.status === 400, "Doit gÃ©rer donnÃ©es manquantes");
    });
%}

### 10.2 Body vide
POST {{baseUrl}}/api/auth/register
Content-Type: application/json

> {%
    client.test("RÃ©silience - Body vide", function() {
        client.assert(response.status === 400, "Doit gÃ©rer body vide");
    });
%}


### =============================================
### 11. RAPPORT FINAL
### =============================================

### 11.1 VÃ©rification finale de l'API publique
GET {{baseUrl}}/api/cities

> {%
    client.test("Test final - API publique", function() {
        client.assert(response.status === 200, "L'API publique doit toujours fonctionner");
        client.log(" ");
        client.log("=== ðŸŽ‰ RAPPORT FINAL ALLTOGETHER ===");
        client.log("âœ… User Token: " + (client.global.get("userToken") ? "DÃ‰FINI" : "MANQUANT"));
        client.log("âœ… Admin Token: " + (client.global.get("adminToken") ? "DÃ‰FINI" : "MANQUANT"));
        client.log("âœ… User ID: " + (client.global.get("userId") || "Non dÃ©fini"));
        client.log("âœ… Place ID: " + (client.global.get("placeId") || "Non dÃ©fini"));
        client.log("âœ… Participation ID: " + (client.global.get("participationId") || "Non dÃ©fini"));
        client.log(" ");
        client.log("ðŸ“Š TESTS EFFECTUÃ‰S:");
        client.log("  â€¢ Endpoints publics");
        client.log("  â€¢ Authentification");
        client.log("  â€¢ Permissions utilisateur");
        client.log("  â€¢ Permissions admin");
        client.log("  â€¢ Gestion des lieux");
        client.log("  â€¢ Gestion des participations");
        client.log("  â€¢ PrÃ©vention des doublons");
        client.log("  â€¢ SÃ©curitÃ© avancÃ©e");
        client.log("  â€¢ RÃ©silience aux erreurs");
        client.log("=== FIN DU RAPPORT ===");
    });
%}